<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Image Distance Calibration Tool</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #222;
    color: #eee;
    text-align: center;
  }

  #controls {
    margin: 10px;
  }

  canvas {
    border: 1px solid #ccc;
    cursor: crosshair;
    max-width: 95%;
    margin-top: 10px;
  }

  input, button {
    padding: 6px;
    font-size: 16px;
    margin: 4px;
  }

  button {
    cursor: pointer;
  }
</style>
</head>

<body>

<h2>Image Distance Calibration Tool</h2>

<div id="controls">
  <input type="file" id="imageLoader" accept="image/*">
  &nbsp;&nbsp;
  Known length:
  <input type="number" id="realLength" value="1" step="0.1"> cm
  &nbsp;&nbsp;
  <button onclick="saveResult()">Save to Google Sheet</button>
</div>

<p>
  <b>Filename:</b> <span id="filenameDisplay">-</span><br>
  <b>Line length:</b> <span id="pixelLength">0</span> px<br>
  <b>Scale:</b> <span id="scale">0</span> px / cm
</p>

<canvas id="canvas"></canvas>

<script>
/* =========================
   Config
========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyvhoXUjuGxMInklnAihmNTbk3YGF2cIcLGTGRYUXC7nIbYbPGE1nDb869H2fKyga0K/exec";

/* =========================
   Canvas & UI
========================= */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const imageLoader = document.getElementById("imageLoader");
const realLengthInput = document.getElementById("realLength");

const pixelLengthSpan = document.getElementById("pixelLength");
const scaleSpan = document.getElementById("scale");
const filenameDisplay = document.getElementById("filenameDisplay");

let img = new Image();
let drawing = false;
let start = null;
let end = null;
let currentFilename = "";

/* =========================
   Image Load
========================= */
imageLoader.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  currentFilename = file.name.replace(/\.[^/.]+$/, "");
  filenameDisplay.textContent = currentFilename;

  const reader = new FileReader();
  reader.onload = event => {
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      start = null;
      end = null;
      redraw();
      resetResult();
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
});

/* =========================
   Mouse Events
========================= */
canvas.addEventListener("mousedown", e => {
  drawing = true;
  start = getMousePos(e);
  end = start;
});

canvas.addEventListener("mousemove", e => {
  if (!drawing) return;
  end = getMousePos(e);
  redraw();
  updateMeasurements();
});

canvas.addEventListener("mouseup", () => {
  drawing = false;
  updateMeasurements();
});

/* =========================
   Functions
========================= */
function getMousePos(evt) {
  const rect = canvas.getBoundingClientRect();
  return {
    x: (evt.clientX - rect.left) * (canvas.width / rect.width),
    y: (evt.clientY - rect.top) * (canvas.height / rect.height)
  };
}

function redraw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(img, 0, 0);

  if (start && end) {
    ctx.beginPath();
    ctx.moveTo(start.x, start.y);
    ctx.lineTo(end.x, end.y);
    ctx.strokeStyle = "red";
    ctx.lineWidth = 2;
    ctx.stroke();
  }
}

function updateMeasurements() {
  if (!start || !end) return;

  const dx = end.x - start.x;
  const dy = end.y - start.y;
  const pixelLength = Math.sqrt(dx * dx + dy * dy);

  pixelLengthSpan.textContent = pixelLength.toFixed(2);

  const realLength = parseFloat(realLengthInput.value);
  if (realLength > 0) {
    const scale = pixelLength / realLength;
    scaleSpan.textContent = scale.toFixed(2);
  }
}

function resetResult() {
  pixelLengthSpan.textContent = "0";
  scaleSpan.textContent = "0";
}

/* =========================
   Save to Google Sheet
========================= */
function saveResult() {
  const scaleValue = scaleSpan.textContent;

  if (!currentFilename) {
    alert("No image loaded.");
    return;
  }

  if (!scaleValue || scaleValue === "0") {
    alert("Please draw a line first.");
    return;
  }

  const payload = {
    filename: currentFilename,
    scale: `${scaleValue} px / cm`
  };

  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify(payload),
    headers: { "Content-Type": "application/json" }
  })
  .then(res => res.json())   // ← 這裡
  .then(() => alert("Saved to Google Sheet ✅"))
  .catch(err => {
    console.error(err);
    alert("Failed to save ❌");
  });
}
</script>

</body>
</html>
